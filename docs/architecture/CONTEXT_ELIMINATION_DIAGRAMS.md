# Context Elimination Strategy - Visual Diagrams

## Architecture Transformation

### Current State (Before Migration)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ src/app/layout.tsx                                              â”‚
â”‚                                                                  â”‚
â”‚  <ErrorBoundary>                                                â”‚
â”‚    <PWAInstaller />                                             â”‚
â”‚    <QueryProvider>                     âœ… React Query (KEEP)   â”‚
â”‚      <AuthProvider>                    âŒ Global Auth State     â”‚
â”‚        <ToastProvider>                 âš ï¸  UI Notifications    â”‚
â”‚          <TimerProvider>               âŒ Global Timer State    â”‚
â”‚            {children}                                           â”‚
â”‚          </TimerProvider>                                       â”‚
â”‚        </ToastProvider>                                         â”‚
â”‚      </AuthProvider>                                            â”‚
â”‚                                                                  â”‚
â”‚      <ActivitiesProvider />            âš ï¸  DEPRECATED          â”‚
â”‚      <NotificationsProvider />         âš ï¸  DEPRECATED          â”‚
â”‚    </QueryProvider>                                             â”‚
â”‚  </ErrorBoundary>                                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Problems:
â”œâ”€ ğŸ”´ 5 global providers creating tight coupling
â”œâ”€ ğŸ”´ Context nesting (TimerProvider â†’ AuthProvider)
â”œâ”€ ğŸ”´ Mixed server/client state in contexts
â”œâ”€ ğŸ”´ 199+ architectural boundary violations
â””â”€ ğŸ”´ Difficult to test components in isolation
```

### Target State (After Migration)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ src/app/layout.tsx                                              â”‚
â”‚                                                                  â”‚
â”‚  <ErrorBoundary>                                                â”‚
â”‚    <PWAInstaller />                                             â”‚
â”‚    <QueryProvider>                     âœ… React Query           â”‚
â”‚      <AuthInitializer>                 âœ… Firebase Listener     â”‚
â”‚        <ToastProvider>                 âš ï¸  Optional (or Sonner) â”‚
â”‚          {children}                                             â”‚
â”‚        </ToastProvider>                                         â”‚
â”‚      </AuthInitializer>                                         â”‚
â”‚    </QueryProvider>                                             â”‚
â”‚  </ErrorBoundary>                                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Benefits:
â”œâ”€ âœ… 2-3 minimal providers (down from 5)
â”œâ”€ âœ… No context nesting or dependencies
â”œâ”€ âœ… Clear server/client state separation
â”œâ”€ âœ… Features manage their own state
â””â”€ âœ… Components are independently testable
```

---

## Data Flow Transformation

### Before: Context-Based Data Flow

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         Component                                â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ const { user } = useAuth()                                  â”‚ â”‚
â”‚  â”‚ const { timerState } = useTimer()                           â”‚ â”‚
â”‚  â”‚ const { activities } = useActivities()                      â”‚ â”‚
â”‚  â”‚                                                              â”‚ â”‚
â”‚  â”‚ âŒ Component knows about global contexts                   â”‚ â”‚
â”‚  â”‚ âŒ Tightly coupled to AuthProvider, TimerProvider, etc.    â”‚ â”‚
â”‚  â”‚ âŒ Can't test without mounting all providers               â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      Global Context                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ AuthProvider                                                â”‚ â”‚
â”‚  â”‚ â”œâ”€ useState(user)            âŒ Mixes concerns            â”‚ â”‚
â”‚  â”‚ â”œâ”€ useEffect(fetchUser)      âŒ Manual state management   â”‚ â”‚
â”‚  â”‚ â”œâ”€ Firebase listener         âŒ Hard to test              â”‚ â”‚
â”‚  â”‚ â””â”€ Navigation logic          âŒ Multiple responsibilities â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      Firebase API                                â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ firebaseAuthApi.getCurrentUser()                            â”‚ â”‚
â”‚  â”‚ firebaseSessionApi.getActiveSession()                       â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### After: Feature Hook Data Flow

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         Component                                â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ const { data: user } = useAuth()                            â”‚ â”‚
â”‚  â”‚ const { data: timer } = useActiveTimer()                    â”‚ â”‚
â”‚  â”‚ const { data: activities } = useActivities()                â”‚ â”‚
â”‚  â”‚                                                              â”‚ â”‚
â”‚  â”‚ âœ… Component only knows about feature hooks                â”‚ â”‚
â”‚  â”‚ âœ… No coupling to providers                                â”‚ â”‚
â”‚  â”‚ âœ… Easy to test with mock hooks                            â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              Feature Hooks (React Query Boundary)                â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ useAuth() â†’ useQuery(['auth'])                              â”‚ â”‚
â”‚  â”‚ â”œâ”€ âœ… Automatic caching                                    â”‚ â”‚
â”‚  â”‚ â”œâ”€ âœ… Background refetch                                   â”‚ â”‚
â”‚  â”‚ â”œâ”€ âœ… Loading/error states                                 â”‚ â”‚
â”‚  â”‚ â””â”€ âœ… Optimistic updates                                   â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                       Service Layer                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ AuthService.getCurrentUser()                                â”‚ â”‚
â”‚  â”‚ â”œâ”€ âœ… Pure business logic                                  â”‚ â”‚
â”‚  â”‚ â”œâ”€ âœ… No React dependencies                                â”‚ â”‚
â”‚  â”‚ â”œâ”€ âœ… Easy to test                                         â”‚ â”‚
â”‚  â”‚ â””â”€ âœ… Reusable outside React                               â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      Repository Layer                            â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ AuthRepository.findCurrentUser()                            â”‚ â”‚
â”‚  â”‚ â”œâ”€ âœ… Data access only                                     â”‚ â”‚
â”‚  â”‚ â”œâ”€ âœ… Firebase abstraction                                 â”‚ â”‚
â”‚  â”‚ â””â”€ âœ… Testable with mocks                                  â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Migration Phases Visualization

### Phase Overview

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     Migration Timeline                            â”‚
â”‚                                                                    â”‚
â”‚  Week 1          Week 2          Week 3-5        Week 6           â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”        â”Œâ”€â”€â”€â”€â”€â”        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”          â”‚
â”‚  â”‚Quickâ”‚   â†’    â”‚Timerâ”‚   â†’    â”‚   Auth   â”‚ â†’  â”‚Cleanâ”‚          â”‚
â”‚  â”‚Wins â”‚        â”‚ Mig â”‚        â”‚ Migrationâ”‚    â”‚ up  â”‚          â”‚
â”‚  â””â”€â”€â”€â”€â”€â”˜        â””â”€â”€â”€â”€â”€â”˜        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”˜          â”‚
â”‚                                                                    â”‚
â”‚  ğŸŸ¢ Low Risk    ğŸŸ¡ Medium      ğŸ”´ High Risk    ğŸŸ¢ Low Risk       â”‚
â”‚  2 contexts     1 context      1 context       0 contexts         â”‚
â”‚  ~60 files      ~47 files      ~74 files       Docs/Rules        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Phase 1: Quick Wins (Week 1)

```
Before Phase 1:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ layout.tsx                            â”‚
â”‚ â”œâ”€ QueryProvider                     â”‚
â”‚ â”‚  â”œâ”€ AuthProvider                   â”‚
â”‚ â”‚  â”œâ”€ ToastProvider                  â”‚
â”‚ â”‚  â”œâ”€ TimerProvider                  â”‚
â”‚ â”‚  â”œâ”€ NotificationsProvider âš ï¸       â”‚
â”‚ â”‚  â””â”€ ActivitiesProvider âš ï¸          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

After Phase 1:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ layout.tsx                            â”‚
â”‚ â”œâ”€ QueryProvider                     â”‚
â”‚ â”‚  â”œâ”€ AuthProvider                   â”‚
â”‚ â”‚  â”œâ”€ ToastProvider                  â”‚
â”‚ â”‚  â””â”€ TimerProvider                  â”‚
â”‚ â”‚                                     â”‚
â”‚ â”‚  âŒ NotificationsProvider REMOVED â”‚
â”‚ â”‚  âŒ ActivitiesProvider REMOVED    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Components now use:
  import { useNotifications } from '@/hooks/useNotifications'
  import { useActivities } from '@/hooks/useActivitiesQuery'

Effort: 6 hours
Files Changed: ~60
Risk: ğŸŸ¢ Low
```

### Phase 2: Timer Migration (Week 2)

```
Before Phase 2:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ TimerProvider (Context)                               â”‚
â”‚ â”œâ”€ âŒ Server state (active session)                  â”‚
â”‚ â”œâ”€ âŒ Client state (isRunning, elapsed)              â”‚
â”‚ â”œâ”€ âŒ Auto-save logic (every 30s)                    â”‚
â”‚ â”œâ”€ âŒ Cross-tab sync (localStorage)                  â”‚
â”‚ â””â”€ âŒ Depends on AuthProvider                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

After Phase 2:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Feature Hooks (No Provider Needed)                    â”‚
â”‚                                                        â”‚
â”‚ useActiveTimer() - React Query                        â”‚
â”‚ â”œâ”€ âœ… Server state (active session)                  â”‚
â”‚ â”œâ”€ âœ… Auto-refetch (handles cross-tab)               â”‚
â”‚ â””â”€ âœ… No auth dependency                             â”‚
â”‚                                                        â”‚
â”‚ useTimerState() - Local State Hook                    â”‚
â”‚ â”œâ”€ âœ… Client state (isRunning, elapsed)              â”‚
â”‚ â”œâ”€ âœ… Timer tick logic                               â”‚
â”‚ â””â”€ âœ… No provider needed                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

layout.tsx after:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ â”œâ”€ QueryProvider                     â”‚
â”‚ â”‚  â”œâ”€ AuthProvider                   â”‚
â”‚ â”‚  â””â”€ ToastProvider                  â”‚
â”‚ â”‚                                     â”‚
â”‚ â”‚  âŒ TimerProvider REMOVED          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Effort: 8 hours
Files Changed: ~47
Risk: ğŸŸ¡ Medium
```

### Phase 3: Auth Migration (Weeks 3-5)

```
Before Phase 3:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ AuthProvider (Context)                                â”‚
â”‚ â”œâ”€ âŒ Global auth state                              â”‚
â”‚ â”œâ”€ âŒ Firebase listener lifecycle                    â”‚
â”‚ â”œâ”€ âŒ Login/logout/signup logic                      â”‚
â”‚ â”œâ”€ âŒ OAuth redirect handling                        â”‚
â”‚ â”œâ”€ âŒ Navigation coupling                            â”‚
â”‚ â””â”€ âŒ Used by 74 files                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

After Phase 3:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ AuthInitializer (Minimal Root Component)              â”‚
â”‚ â””â”€ useAuthListener()                                  â”‚
â”‚    â”œâ”€ âœ… Subscribes to Firebase Auth once            â”‚
â”‚    â””â”€ âœ… Updates React Query cache                   â”‚
â”‚                                                        â”‚
â”‚ Feature Hooks (Used by Components)                    â”‚
â”‚ â”œâ”€ useAuth() - React Query                           â”‚
â”‚ â”‚  â”œâ”€ âœ… Reads from cache                            â”‚
â”‚ â”‚  â””â”€ âœ… Automatic refetch                           â”‚
â”‚ â”‚                                                      â”‚
â”‚ â”œâ”€ useLogin() - Mutation                              â”‚
â”‚ â”‚  â”œâ”€ âœ… Login logic                                 â”‚
â”‚ â”‚  â””â”€ âœ… Updates cache + navigates                   â”‚
â”‚ â”‚                                                      â”‚
â”‚ â””â”€ useLogout() - Mutation                             â”‚
â”‚    â”œâ”€ âœ… Logout logic                                â”‚
â”‚    â””â”€ âœ… Clears cache + navigates                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

layout.tsx after:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ â”œâ”€ QueryProvider                     â”‚
â”‚ â”‚  â”œâ”€ AuthInitializer âœ…             â”‚
â”‚ â”‚  â””â”€ ToastProvider                  â”‚
â”‚ â”‚                                     â”‚
â”‚ â”‚  âŒ AuthProvider REMOVED           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Effort: 24 hours
Files Changed: ~74
Risk: ğŸ”´ High (mitigated by phased approach)
```

---

## State Management Comparison

### Context Pattern (Current)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Global Context State                                     â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚ â”‚ AuthProvider                                         â”‚ â”‚
â”‚ â”‚ â”œâ”€ useState(user)                                    â”‚ â”‚
â”‚ â”‚ â”œâ”€ useState(isLoading)                               â”‚ â”‚
â”‚ â”‚ â”œâ”€ useEffect(() => fetch...)                         â”‚ â”‚
â”‚ â”‚ â””â”€ Manual cache invalidation                         â”‚ â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                           â”‚
â”‚ Problems:                                                 â”‚
â”‚ â”œâ”€ âŒ No automatic caching                              â”‚
â”‚ â”œâ”€ âŒ No automatic refetch                              â”‚
â”‚ â”œâ”€ âŒ Manual loading states                             â”‚
â”‚ â”œâ”€ âŒ No optimistic updates                             â”‚
â”‚ â”œâ”€ âŒ Renders entire subtree on change                  â”‚
â”‚ â””â”€ âŒ Hard to test                                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### React Query Pattern (Target)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ React Query Cache (per-feature)                          â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚ â”‚ useAuth() from @/features/auth/hooks                 â”‚ â”‚
â”‚ â”‚ â””â”€ useQuery(['auth', 'session'])                     â”‚ â”‚
â”‚ â”‚    â”œâ”€ queryFn: () => authService.getCurrentUser()   â”‚ â”‚
â”‚ â”‚    â”œâ”€ staleTime: 5 * 60 * 1000                       â”‚ â”‚
â”‚ â”‚    â””â”€ refetchOnWindowFocus: true                     â”‚ â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                           â”‚
â”‚ Benefits:                                                 â”‚
â”‚ â”œâ”€ âœ… Automatic caching (5min)                          â”‚
â”‚ â”œâ”€ âœ… Automatic background refetch                      â”‚
â”‚ â”œâ”€ âœ… Built-in loading/error states                     â”‚
â”‚ â”œâ”€ âœ… Optimistic updates support                        â”‚
â”‚ â”œâ”€ âœ… Only re-renders consumers                         â”‚
â”‚ â””â”€ âœ… Easy to test (mock cache)                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Dependency Graph

### Before: Tangled Dependencies

```
                      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                      â”‚  layout.tsx  â”‚
                      â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
                             â”‚
              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
              â”‚              â”‚              â”‚
        â”Œâ”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”
        â”‚ AuthProviderâ”‚ â”‚TimerProv â”‚ â”‚ Activities â”‚
        â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
              â”‚             â”‚              â”‚
              â”‚      â”Œâ”€â”€â”€â”€â”€â”€â”˜              â”‚
              â”‚      â”‚                     â”‚
              â–¼      â–¼                     â–¼
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚          Components (74 files)      â”‚
        â”‚  âŒ Tight coupling to contexts      â”‚
        â”‚  âŒ Can't test independently        â”‚
        â”‚  âŒ Circular dependencies           â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Problems:
â”œâ”€ TimerProvider depends on AuthProvider
â”œâ”€ Components depend on multiple contexts
â”œâ”€ Contexts can't be tested separately
â””â”€ Changes cascade through entire tree
```

### After: Clean Dependencies

```
                      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                      â”‚  layout.tsx  â”‚
                      â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
                             â”‚
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚  QueryProvider   â”‚
                    â”‚  AuthInitializer â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â”‚
                    (No global state)
                             â”‚
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚                    â”‚                    â”‚
    â”Œâ”€â”€â”€â–¼â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”       â”Œâ”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”
    â”‚ Featureâ”‚         â”‚  Feature  â”‚       â”‚ Feature  â”‚
    â”‚ Hooks  â”‚         â”‚   Hooks   â”‚       â”‚  Hooks   â”‚
    â””â”€â”€â”€â”¬â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜       â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜
        â”‚                    â”‚                    â”‚
    â”Œâ”€â”€â”€â–¼â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”       â”Œâ”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”
    â”‚Servicesâ”‚         â”‚ Services  â”‚       â”‚ Services â”‚
    â””â”€â”€â”€â”¬â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜       â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜
        â”‚                    â”‚                    â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â”‚
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚  Repositories    â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Benefits:
â”œâ”€ âœ… No context dependencies
â”œâ”€ âœ… Features are independent
â”œâ”€ âœ… Easy to test each layer
â””â”€ âœ… Changes are localized
```

---

## Testing Strategy Comparison

### Context Testing (Difficult)

```
// âŒ Current: Must mount entire provider tree
describe('MyComponent', () => {
  it('should render user name', () => {
    render(
      <QueryProvider>
        <AuthProvider>
          <ToastProvider>
            <TimerProvider>
              <MyComponent />
            </TimerProvider>
          </ToastProvider>
        </AuthProvider>
      </QueryProvider>
    );

    // âŒ Hard to mock auth state
    // âŒ Hard to test error states
    // âŒ Slow (mounts entire tree)
  });
});
```

### React Query Testing (Easy)

```
// âœ… Target: Mock hooks directly
import { useAuth } from '@/features/auth/hooks';

jest.mock('@/features/auth/hooks');

describe('MyComponent', () => {
  it('should render user name', () => {
    // âœ… Easy to mock
    useAuth.mockReturnValue({
      data: { name: 'John' },
      isLoading: false,
    });

    render(<MyComponent />);

    // âœ… Fast (no provider tree)
    // âœ… Easy to test error states
    // âœ… Clear what's being tested
  });

  it('should show loading state', () => {
    useAuth.mockReturnValue({
      data: null,
      isLoading: true,
    });

    render(<MyComponent />);
    expect(screen.getByText('Loading...')).toBeInTheDocument();
  });
});
```

---

## File Structure Transformation

### Before: Scattered State Management

```
src/
â”œâ”€â”€ contexts/
â”‚   â”œâ”€â”€ AuthContext.tsx              âŒ 200 lines of mixed concerns
â”‚   â”œâ”€â”€ TimerContext.tsx             âŒ 500+ lines of mixed concerns
â”‚   â”œâ”€â”€ ActivitiesContext.tsx        âŒ 300+ lines
â”‚   â”œâ”€â”€ NotificationsContext.tsx     âŒ Deprecated
â”‚   â””â”€â”€ ToastContext.tsx             âš ï¸  UI-only (keep or replace)
â”‚
â”œâ”€â”€ hooks/
â”‚   â”œâ”€â”€ useTimerQuery.ts             âœ… Partially migrated
â”‚   â”œâ”€â”€ useActivitiesQuery.ts        âœ… Migration complete
â”‚   â””â”€â”€ useNotifications.ts          âœ… Migration complete
â”‚
â”œâ”€â”€ components/
â”‚   â””â”€â”€ MyComponent.tsx
â”‚       import { useAuth } from '@/contexts/AuthContext'  âŒ
â”‚       import { useTimer } from '@/contexts/TimerContext' âŒ
â”‚
â””â”€â”€ app/
    â””â”€â”€ layout.tsx
        <AuthProvider>                âŒ Global singleton
        <TimerProvider>               âŒ Global singleton
```

### After: Clean Feature-Based Structure

```
src/
â”œâ”€â”€ features/
â”‚   â”œâ”€â”€ auth/
â”‚   â”‚   â”œâ”€â”€ services/
â”‚   â”‚   â”‚   â””â”€â”€ AuthService.ts       âœ… Pure business logic
â”‚   â”‚   â”œâ”€â”€ hooks/
â”‚   â”‚   â”‚   â”œâ”€â”€ useAuth.ts           âœ… React Query boundary
â”‚   â”‚   â”‚   â”œâ”€â”€ useAuthMutations.ts  âœ… Login/logout
â”‚   â”‚   â”‚   â””â”€â”€ index.ts             âœ… Public API
â”‚   â”‚   â””â”€â”€ types/
â”‚   â”‚       â””â”€â”€ index.ts             âœ… Feature types
â”‚   â”‚
â”‚   â”œâ”€â”€ timer/
â”‚   â”‚   â”œâ”€â”€ services/
â”‚   â”‚   â”‚   â””â”€â”€ TimerService.ts      âœ… Pure business logic
â”‚   â”‚   â”œâ”€â”€ hooks/
â”‚   â”‚   â”‚   â”œâ”€â”€ useActiveTimer.ts    âœ… Server state
â”‚   â”‚   â”‚   â”œâ”€â”€ useTimerState.ts     âœ… Client state
â”‚   â”‚   â”‚   â”œâ”€â”€ useTimerMutations.ts âœ… Start/stop/finish
â”‚   â”‚   â”‚   â””â”€â”€ index.ts             âœ… Public API
â”‚   â”‚   â””â”€â”€ types/
â”‚   â”‚       â””â”€â”€ index.ts             âœ… Feature types
â”‚   â”‚
â”‚   â””â”€â”€ activities/
â”‚       â”œâ”€â”€ services/
â”‚       â”‚   â””â”€â”€ ActivityService.ts   âœ… Pure business logic
â”‚       â”œâ”€â”€ hooks/
â”‚       â”‚   â”œâ”€â”€ useActivities.ts     âœ… React Query boundary
â”‚       â”‚   â””â”€â”€ index.ts             âœ… Public API
â”‚       â””â”€â”€ types/
â”‚           â””â”€â”€ index.ts             âœ… Feature types
â”‚
â”œâ”€â”€ components/
â”‚   â””â”€â”€ MyComponent.tsx
â”‚       import { useAuth } from '@/features/auth/hooks'     âœ…
â”‚       import { useActiveTimer } from '@/features/timer/hooks' âœ…
â”‚
â””â”€â”€ app/
    â””â”€â”€ layout.tsx
        <QueryProvider>              âœ… Infrastructure only
        <AuthInitializer />          âœ… Minimal listener
```

---

## Performance Impact

### Context Re-Rendering

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Context Pattern (Current)                                â”‚
â”‚                                                           â”‚
â”‚  User login â†’ AuthProvider state change                  â”‚
â”‚       â†“                                                   â”‚
â”‚  Entire subtree re-renders                               â”‚
â”‚       â”œâ”€ Header                                          â”‚
â”‚       â”œâ”€ Sidebar                                         â”‚
â”‚       â”œâ”€ Feed                                            â”‚
â”‚       â””â”€ All 74 consumers                                â”‚
â”‚                                                           â”‚
â”‚  âŒ Unnecessary re-renders                               â”‚
â”‚  âŒ Performance issues with large trees                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### React Query Re-Rendering

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ React Query Pattern (Target)                             â”‚
â”‚                                                           â”‚
â”‚  User login â†’ Update cache ['auth', 'session']           â”‚
â”‚       â†“                                                   â”‚
â”‚  Only components using useAuth() re-render               â”‚
â”‚       â”œâ”€ Header âœ“                                        â”‚
â”‚       â”œâ”€ Profile âœ“                                       â”‚
â”‚       â””â”€ Other components stay same âœ“                    â”‚
â”‚                                                           â”‚
â”‚  âœ… Minimal re-renders                                   â”‚
â”‚  âœ… Better performance                                   â”‚
â”‚  âœ… Automatic optimization                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Cache Key Hierarchy

### Hierarchical Cache Keys (Best Practice)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Cache Key Structure                                      â”‚
â”‚                                                           â”‚
â”‚  ['auth']                         â† Root                 â”‚
â”‚  â”œâ”€ ['auth', 'session']           â† Current session      â”‚
â”‚  â””â”€ ['auth', 'user', userId]      â† Specific user        â”‚
â”‚                                                           â”‚
â”‚  ['timer']                        â† Root                 â”‚
â”‚  â”œâ”€ ['timer', 'active']           â† Active timer         â”‚
â”‚  â””â”€ ['timer', 'history', userId]  â† Timer history        â”‚
â”‚                                                           â”‚
â”‚  ['activities']                   â† Root                 â”‚
â”‚  â”œâ”€ ['activities', 'list', userId] â† User's activities  â”‚
â”‚  â”œâ”€ ['activities', 'detail', id]   â† Single activity    â”‚
â”‚  â””â”€ ['activities', 'stats', id]    â† Activity stats     â”‚
â”‚                                                           â”‚
â”‚  Benefits:                                                â”‚
â”‚  â”œâ”€ Invalidate entire feature: invalidate(['auth'])     â”‚
â”‚  â”œâ”€ Invalidate specific data: invalidate(['auth','user'])â”‚
â”‚  â””â”€ TypeScript autocomplete for keys                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Implementation

```typescript
// src/features/auth/hooks/cache-keys.ts
export const AUTH_KEYS = {
  all: () => ['auth'] as const,
  session: () => [...AUTH_KEYS.all(), 'session'] as const,
  user: (userId: string) => [...AUTH_KEYS.all(), 'user', userId] as const,
}

// Usage
queryClient.invalidateQueries({ queryKey: AUTH_KEYS.all() })
queryClient.invalidateQueries({ queryKey: AUTH_KEYS.session() })
queryClient.setQueryData(AUTH_KEYS.session(), newUser)
```

---

## Rollback Strategy

### Safety Net for Each Phase

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Phase 1: Quick Wins                                      â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚ â”‚ Rollback: git revert <commit>                        â”‚ â”‚
â”‚ â”‚ Time: 5 minutes                                      â”‚ â”‚
â”‚ â”‚ Risk: None (deprecated contexts already)             â”‚ â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                           â”‚
â”‚ Phase 2: Timer                                           â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚ â”‚ Rollback: git revert <commit>                        â”‚ â”‚
â”‚ â”‚ Time: 5 minutes                                      â”‚ â”‚
â”‚ â”‚ Risk: Low (timer isolated feature)                   â”‚ â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                           â”‚
â”‚ Phase 3: Auth (High Risk - Extra Safety)                â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚ â”‚ Option 1: git revert <commit>                        â”‚ â”‚
â”‚ â”‚ Time: 5 minutes                                      â”‚ â”‚
â”‚ â”‚                                                       â”‚ â”‚
â”‚ â”‚ Option 2: Feature flag                               â”‚ â”‚
â”‚ â”‚ if (USE_NEW_AUTH) {                                  â”‚ â”‚
â”‚ â”‚   return <AuthInitializer />                         â”‚ â”‚
â”‚ â”‚ } else {                                             â”‚ â”‚
â”‚ â”‚   return <AuthProvider />                            â”‚ â”‚
â”‚ â”‚ }                                                     â”‚ â”‚
â”‚ â”‚ Time: Instant toggle                                 â”‚ â”‚
â”‚ â”‚                                                       â”‚ â”‚
â”‚ â”‚ Option 3: Gradual rollout (Vercel Edge Config)      â”‚ â”‚
â”‚ â”‚ - 10% of users â†’ new auth                           â”‚ â”‚
â”‚ â”‚ - Monitor error rates                                â”‚ â”‚
â”‚ â”‚ - Rollback if issues                                 â”‚ â”‚
â”‚ â”‚ - Scale to 100% when stable                          â”‚ â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Success Metrics Dashboard

### Week 1 Target

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Quick Wins Metrics                        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Providers removed:     2 / 2     âœ…     â”‚
â”‚ Files migrated:       60 / 60    âœ…     â”‚
â”‚ Tests passing:       100%        âœ…     â”‚
â”‚ Bundle size change:   -2.3%      âœ…     â”‚
â”‚ Performance change:   +3.1%      âœ…     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Week 2 Target

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Timer Migration Metrics                   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Providers removed:     1 / 1     âœ…     â”‚
â”‚ Files migrated:       47 / 47    âœ…     â”‚
â”‚ Timer accuracy:       100%       âœ…     â”‚
â”‚ Cross-tab sync:       Working    âœ…     â”‚
â”‚ Error rate:           <0.1%      âœ…     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Week 5 Target (End of Auth Migration)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Auth Migration Metrics                    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Providers removed:     1 / 1     âœ…     â”‚
â”‚ Files migrated:       74 / 74    âœ…     â”‚
â”‚ Auth success rate:    99.9%      âœ…     â”‚
â”‚ Session persistence:  100%       âœ…     â”‚
â”‚ OAuth flows:          Working    âœ…     â”‚
â”‚ Performance:          +15%       âœ…     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Conclusion

This visual guide illustrates the transformation from a tightly-coupled context-based architecture to a clean, feature-based architecture using React Query at feature boundaries.

**Key Takeaways:**

1. âœ… Clear before/after visualization of architecture
2. âœ… Phased approach minimizes risk
3. âœ… Each phase has concrete deliverables
4. âœ… Rollback strategies at every stage
5. âœ… Success metrics track progress

**Next:** Review full strategy in [CONTEXT_ELIMINATION_STRATEGY.md](./CONTEXT_ELIMINATION_STRATEGY.md)

---

**Version:** 1.0
**Created:** 2025-10-27
